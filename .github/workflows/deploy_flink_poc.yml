# ========================================================
# POC: GitHub Action éƒ¨ç½² Flink JAR åˆ°é˜¿é‡Œäº‘
# ========================================================
# å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–ä»»ä½• Kering å†…éƒ¨ç»„ä»¶
#
# å‰ç½®æ¡ä»¶:
# 1. åœ¨ GitHub Secrets é…ç½®: ALIYUN_ACCESS_KEY_ID, ALIYUN_ACCESS_KEY_SECRET
# 2. åœ¨ GitHub Secrets é…ç½®: FLINK_OSS_BUCKET, FLINK_OSS_REGION, FLINK_WORKSPACE, FLINK_NAMESPACE, FLINK_REGION
# 3. JAR å·²ä¸Šä¼ åˆ° OSSï¼ˆæœ¬æµæ°´çº¿ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼‰

name: POC - Deploy Flink to Aliyun

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy_flink_poc.yml'
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæŽ¨èé¦–æ¬¡ç”¨è¿™ä¸ªï¼‰

env:
  JOB_NAME: poc-flink-hello-world
  JAR_VERSION: 1.0.0-SNAPSHOT
  ENTRY_CLASS: com.example.flink.HelloWorldFlinkJob

jobs:
  # ==========================================
  # Job 1: æž„å»º JAR åŒ…
  # ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Upload JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flink-jar
          path: ./target/poc-flink-hello-world-*.jar
          retention-days: 3

  # ==========================================
  # Job 2: ä¸Šä¼ åˆ° OSS å¹¶éƒ¨ç½²åˆ° Flink
  # ==========================================
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: flink-jar
          path: ./jars

      - name: List JAR files
        run: ls -la ./jars/

      # ==========================================
      # Step: å®‰è£…å¹¶é…ç½®é˜¿é‡Œäº‘ CLI
      # ==========================================
      - name: Install Aliyun CLI
        run: |
          echo "ðŸ“¦ Installing Aliyun CLI..."
          wget -q https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun version
          echo "âœ… Aliyun CLI installed"

      - name: Configure Aliyun CLI
        run: |
          aliyun configure set \
            --profile default \
            --mode AK \
            --region ${{ secrets.FLINK_OSS_REGION }} \
            --access-key-id "${{ secrets.ALIYUN_ACCESS_KEY_ID }}" \
            --access-key-secret "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"
          echo "âœ… CLI configured"

      - name: Validate required variables
        run: |
          MISSING=""
          [ -z "${{ secrets.FLINK_OSS_BUCKET }}" ] && MISSING="${MISSING} OSS_BUCKET"
          [ -z "${{ secrets.FLINK_OSS_REGION }}" ] && MISSING="${MISSING} OSS_REGION"
          [ -z "${{ secrets.FLINK_WORKSPACE }}" ] && MISSING="${MISSING} FLINK_WORKSPACE"
          [ -z "${{ secrets.FLINK_NAMESPACE }}" ] && MISSING="${MISSING} FLINK_NAMESPACE"
          [ -z "${{ secrets.FLINK_REGION }}" ] && MISSING="${MISSING} FLINK_REGION"
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required GitHub Variables:${MISSING}"
            echo "   è¯·åœ¨ GitHub ä»“åº“ Settings â†’ Secrets and variables â†’ Actions â†’ Variables ä¸­é…ç½®"
            exit 1
          fi
          echo "âœ… All required variables are set"

      # ==========================================
      # Step: ä¸Šä¼  JAR åˆ° OSSï¼ˆä½¿ç”¨ aliyun oss å‘½ä»¤ï¼‰
      # ==========================================
      - name: Upload JAR to OSS
        run: |
          JAR_FILE=$(ls ./jars/*.jar | head -1)
          JAR_FILENAME=$(basename $JAR_FILE)
          echo "Uploading $JAR_FILENAME to OSS..."

          OSS_PATH="oss://${{ secrets.FLINK_OSS_BUCKET }}/artifacts/namespaces/${{ secrets.FLINK_NAMESPACE }}/${JAR_FILENAME}"
          echo "OSS target: $OSS_PATH"

          aliyun oss cp "$JAR_FILE" "$OSS_PATH" -f --region ${{ secrets.FLINK_OSS_REGION }}

          echo "jar_oss_path=$OSS_PATH" >> $GITHUB_ENV
          echo "âœ… JAR uploaded successfully"


      # ==========================================
      # Step: éƒ¨ç½² Flink ä½œä¸šåˆ°é˜¿é‡Œäº‘ Realtime Compute
      # ==========================================
      - name: Deploy Flink Job
        env:
          FLINK_ENDPOINT: ververica.${{ secrets.FLINK_REGION }}.aliyuncs.com
          FLINK_WORKSPACE: ${{ secrets.FLINK_WORKSPACE }}
          FLINK_NAMESPACE: ${{ secrets.FLINK_NAMESPACE }}
        run: |
          echo "ðŸš€ Deploying Flink job: ${{ env.JOB_NAME }}"
          echo "  OSS JAR path: ${jar_oss_path}"
          echo "  Entry class:  ${{ env.ENTRY_CLASS }}"
          echo "  Workspace:    ${FLINK_WORKSPACE}"
          echo "  Namespace:    ${FLINK_NAMESPACE}"

          # æž„å»ºéƒ¨ç½²è¯·æ±‚ bodyï¼ˆä½¿ç”¨ jq ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ï¼‰
          DEPLOY_BODY=$(jq -n \
            --arg name "${{ env.JOB_NAME }}" \
            --arg ns "${FLINK_NAMESPACE}" \
            --arg jarUri "${jar_oss_path}" \
            --arg entryClass "${{ env.ENTRY_CLASS }}" \
            '{
              metadata: { name: $name, namespace: $ns },
              spec: {
                state: "RUNNING",
                template: {
                  spec: {
                    artifact: {
                      kind: "JAR",
                      jarUri: $jarUri,
                      entryClass: $entryClass
                    },
                    parallelism: 1,
                    resources: {
                      jobmanager: { cpu: 0.5, memory: "1Gi" },
                      taskmanager: { cpu: 0.5, memory: "1Gi" }
                    }
                  }
                }
              }
            }')

          echo "ðŸ“„ Deployment config:"
          echo "$DEPLOY_BODY" | jq .

          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒå deployment
          echo "ðŸ” Checking for existing deployment..."
          LIST_RESULT=$(aliyun ververica GET \
            "/api/v2/namespaces/${FLINK_NAMESPACE}/deployments" \
            --endpoint "${FLINK_ENDPOINT}" \
            --header "workspace=${FLINK_WORKSPACE}" \
            2>&1) || true

          DEPLOY_ID=$(echo "$LIST_RESULT" | jq -r \
            ".data.deployments[]? | select(.metadata.name==\"${{ env.JOB_NAME }}\") | .metadata.id" \
            2>/dev/null) || DEPLOY_ID=""

          if [ -n "$DEPLOY_ID" ] && [ "$DEPLOY_ID" != "null" ]; then
            echo "ðŸ“ Updating existing deployment (ID: ${DEPLOY_ID})..."
            RESULT=$(aliyun ververica PATCH \
              "/api/v2/namespaces/${FLINK_NAMESPACE}/deployments/${DEPLOY_ID}" \
              --endpoint "${FLINK_ENDPOINT}" \
              --header "workspace=${FLINK_WORKSPACE}" \
              --header "Content-Type=application/json" \
              --body "$DEPLOY_BODY" 2>&1) || {
                echo "âŒ Failed to update deployment"
                echo "$RESULT"
                exit 1
              }
          else
            echo "ðŸ†• No existing deployment found, creating new one..."
            RESULT=$(aliyun ververica POST \
              "/api/v2/namespaces/${FLINK_NAMESPACE}/deployments" \
              --endpoint "${FLINK_ENDPOINT}" \
              --header "workspace=${FLINK_WORKSPACE}" \
              --header "Content-Type=application/json" \
              --body "$DEPLOY_BODY" 2>&1) || {
                echo "âŒ Failed to create deployment"
                echo "$RESULT"
                exit 1
              }
          fi

          echo "$RESULT" | jq . 2>/dev/null || echo "$RESULT"
          echo "âœ… Flink job deployment completed!"
