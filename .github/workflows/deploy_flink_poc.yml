# ========================================================
# POC: GitHub Action 部署 Flink JAR 到阿里云
# ========================================================
# 完全独立，不依赖任何 Kering 内部组件
#
# 前置条件:
# 1. 在 GitHub Secrets 配置: ALIYUN_ACCESS_KEY_ID, ALIYUN_ACCESS_KEY_SECRET
# 2. 在 GitHub Variables 配置: OSS_BUCKET, OSS_REGION, FLINK_WORKSPACE, FLINK_NAMESPACE, FLINK_REGION
# 3. JAR 已上传到 OSS（本流水线会自动上传）

name: POC - Deploy Flink to Aliyun

on:
  push:
    branches: [ "main" ]
    paths:
      - 'poc/**'
  workflow_dispatch:        # 允许手动触发（推荐首次用这个）

env:
  JOB_NAME: poc-flink-hello-world
  JAR_VERSION: 1.0.0-SNAPSHOT
  ENTRY_CLASS: com.example.flink.HelloWorldFlinkJob

jobs:
  # ==========================================
  # Job 1: 构建 JAR 包
  # ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build JAR
        working-directory: ./poc
        run: mvn clean package -DskipTests

      - name: Upload JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flink-jar
          path: ./poc/target/poc-flink-hello-world-*.jar
          retention-days: 3

  # ==========================================
  # Job 2: 上传到 OSS 并部署到 Flink
  # ==========================================
  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: flink-jar
          path: ./jars

      - name: List JAR files
        run: ls -la ./jars/

      # ==========================================
      # Step: 安装 ossutil 并上传 JAR 到 OSS
      # ==========================================
      - name: Install ossutil
        run: |
          curl -o ossutil https://gosspublic.alicdn.com/ossutil/v2/2.0.3-beta.09171530/linux-amd64/ossutil
          chmod +x ossutil
          sudo mv ossutil /usr/local/bin/

      - name: Upload JAR to OSS
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
        run: |
          JAR_FILE=$(ls ./jars/*.jar | head -1)
          JAR_FILENAME=$(basename $JAR_FILE)
          echo "Uploading $JAR_FILENAME to OSS..."

          OSS_PATH="oss://${{ vars.OSS_BUCKET }}/artifacts/namespaces/${{ vars.FLINK_NAMESPACE }}/${JAR_FILENAME}"
          echo "OSS target: $OSS_PATH"

          ossutil cp "$JAR_FILE" "$OSS_PATH" \
            --access-key-id "$OSS_ACCESS_KEY_ID" \
            --access-key-secret "$OSS_ACCESS_KEY_SECRET" \
            --region ${{ vars.OSS_REGION }} \
            --force

          echo "jar_oss_path=$OSS_PATH" >> $GITHUB_ENV
          echo "✅ JAR uploaded successfully"

      # ==========================================
      # Step: 部署 Flink 作业（复用团队标准 Action）
      # ==========================================
      - name: Deploy to Flink
        uses: kering-technologies-china/dso-cus-github-action/flink/deploy-to-flink@main
        with:
          jobName: ${{ env.JOB_NAME }}
          jarFilename: ${{ env.JOB_NAME }}-${{ env.JAR_VERSION }}.jar
