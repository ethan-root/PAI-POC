# ========================================================
# POC: GitHub Action éƒ¨ç½² Flink JAR åˆ°é˜¿é‡Œäº‘
# ========================================================
# å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¾èµ–ä»»ä½• Kering å†…éƒ¨ç»„ä»¶
#
# å‰ç½®æ¡ä»¶:
# 1. åœ¨ GitHub Secrets é…ç½®: FLINK_ACCESS_KEY, FLINK_ACCESS_SECRET
# 2. åœ¨ GitHub Secrets é…ç½®: FLINK_OSS_BUCKET, FLINK_OSS_REGION, FLINK_WORKSPACE, FLINK_NAMESPACE, FLINK_REGION
# 3. JAR å·²ä¸Šä¼ åˆ° OSSï¼ˆæœ¬æµæ°´çº¿ä¼šè‡ªåŠ¨ä¸Šä¼ ï¼‰

name: POC - Deploy Flink to Aliyun

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy_flink_poc.yml'
      - '.github/scripts/**'
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼ˆæŽ¨èé¦–æ¬¡ç”¨è¿™ä¸ªï¼‰

env:
  JOB_NAME: poc-flink-hello-world
  JAR_VERSION: 1.0.0-SNAPSHOT
  ENTRY_CLASS: com.example.flink.HelloWorldFlinkJob

jobs:
  # ==========================================
  # Job 1: æž„å»º JAR åŒ…
  # ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Upload JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flink-jar
          path: ./target/poc-flink-hello-world-*.jar
          retention-days: 3

  # ==========================================
  # Job 2: ä¸Šä¼ åˆ° OSS å¹¶éƒ¨ç½²åˆ° Flink
  # ==========================================
  # ==========================================
  # Job 2: ä¸Šä¼ åˆ° OSS å¹¶éƒ¨ç½²åˆ° Flink (Matrix Strategy)
  # ==========================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - job_name: poc-flink-infinite-job-a
            entry_class: com.example.flink.InfiniteFlinkJobA
          - job_name: poc-flink-infinite-job-b
            entry_class: com.example.flink.InfiniteFlinkJobB

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: flink-jar
          path: ./jars

      - name: List JAR files
        run: ls -la ./jars/

      # ==========================================
      # Step: å®‰è£…å¹¶é…ç½®é˜¿é‡Œäº‘ CLI
      # ==========================================
      - name: Install Aliyun CLI
        run: |
          echo "ðŸ“¦ Installing Aliyun CLI..."
          wget -q https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun version
          echo "âœ… Aliyun CLI installed"

      - name: Configure Aliyun CLI
        run: |
          aliyun configure set \
            --profile default \
            --mode AK \
            --region ${{ secrets.FLINK_OSS_REGION }} \
            --access-key-id "${{ secrets.FLINK_ACCESS_KEY }}" \
            --access-key-secret "${{ secrets.FLINK_ACCESS_SECRET }}"
          echo "âœ… CLI configured"

      - name: Validate required variables
        run: |
          MISSING=""
          [ -z "${{ secrets.FLINK_OSS_BUCKET }}" ] && MISSING="${MISSING} OSS_BUCKET"
          [ -z "${{ secrets.FLINK_OSS_REGION }}" ] && MISSING="${MISSING} OSS_REGION"
          [ -z "${{ secrets.FLINK_WORKSPACE }}" ] && MISSING="${MISSING} FLINK_WORKSPACE"
          [ -z "${{ secrets.FLINK_NAMESPACE }}" ] && MISSING="${MISSING} FLINK_NAMESPACE"
          [ -z "${{ secrets.FLINK_REGION }}" ] && MISSING="${MISSING} FLINK_REGION"
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required GitHub Variables:${MISSING}"
            echo "   è¯·åœ¨ GitHub ä»“åº“ Settings â†’ Secrets and variables â†’ Actions â†’ Variables ä¸­é…ç½®"
            exit 1
          fi
          echo "âœ… All required variables are set"

      # ==========================================
      # Step: ä¸Šä¼  JAR åˆ° OSSï¼ˆä½¿ç”¨ aliyun oss å‘½ä»¤ï¼‰
      # ==========================================
      - name: Upload JAR to OSS
        run: |
          JAR_FILE=$(ls ./jars/*.jar | head -1)
          JAR_FILENAME=$(basename $JAR_FILE)
          echo "Uploading $JAR_FILENAME to OSS..."

          OSS_PATH="oss://${{ secrets.FLINK_OSS_BUCKET }}/artifacts/namespaces/${{ secrets.FLINK_NAMESPACE }}/${JAR_FILENAME}"
          echo "OSS target: $OSS_PATH"

          aliyun oss cp "$JAR_FILE" "$OSS_PATH" -f --region ${{ secrets.FLINK_OSS_REGION }}

          echo "jar_oss_path=$OSS_PATH" >> $GITHUB_ENV
          echo "âœ… JAR uploaded successfully"


      # ==========================================
      # Step: éƒ¨ç½² Flink ä½œä¸šåˆ°é˜¿é‡Œäº‘ Realtime Compute
      # ==========================================
      - name: Deploy to Flink
        uses: ./.github/actions/deploy-to-flink
        with:
          jobName: ${{ matrix.job_name }}
          jarFilename: ${{ matrix.job_name }}-${{ env.JAR_VERSION }}.jar
          accessKey: ${{ secrets.FLINK_ACCESS_KEY }}
          accessSecret: ${{ secrets.FLINK_ACCESS_SECRET }}
          ossBucket: ${{ secrets.FLINK_OSS_BUCKET }}
          region: ${{ secrets.FLINK_REGION }}
          workspace: ${{ secrets.FLINK_WORKSPACE }}
          namespace: ${{ secrets.FLINK_NAMESPACE }}
          environment: 'poc'
          jobArgsFile: './src/main/deploy/job-args-dev.yml'
          entryClass: ${{ matrix.entry_class }}
