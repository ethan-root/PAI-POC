# ========================================
# POC: GitHub Action éƒ¨ç½² Flink ä½œä¸šåˆ°é˜¿é‡Œäº‘
# ========================================
#
# å·¥ä½œæµç¨‹:
# 1. Maven æ„å»º JAR åŒ…
# 2. ä¸Šä¼  JAR åˆ°é˜¿é‡Œäº‘ OSS
# 3. è°ƒç”¨é˜¿é‡Œäº‘ Flink API éƒ¨ç½²ä½œä¸š

name: POC - Deploy Flink to Aliyun

# ========================================
# è§¦å‘æ¡ä»¶
# ========================================
on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'pom.xml'
  workflow_dispatch:                # å…è®¸æ‰‹åŠ¨è§¦å‘

# ========================================
# ç¯å¢ƒå˜é‡ - TODO: å¡«å†™ä»¥ä¸‹é…ç½®
# ========================================
env:
  ENVIRONMENT: dev

  # é˜¿é‡Œäº‘ OSS é…ç½®
  OSS_BUCKET: "kering-flink-data"
  OSS_REGION: cn-shanghai

  # é˜¿é‡Œäº‘ Flink Serverless é…ç½®
  WORKSPACE: "beba6a92e8174f"
  NAMESPACE: "cn-sh-test-pait"
  FLINK_REGION: cn-shanghai
  FLINK_ENGINE_VERSION: "vvr-8.0.9-flink-1.17"  # TODO: ç¡®è®¤ VVR å¼•æ“ç‰ˆæœ¬

  # ä½œä¸šä¿¡æ¯ (ä¸ pom.xml ä¸­çš„é…ç½®ä¸€è‡´)
  JOB_NAME: poc-flink-hello-world
  JAR_VERSION: 1.0.0-SNAPSHOT

jobs:
  # ========================================
  # å• Job: æ„å»º â†’ ä¸Šä¼  OSS â†’ éƒ¨ç½² Flink
  # ========================================
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # ==============================
      # é˜¶æ®µ 1: æ„å»º JAR
      # ==============================
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build JAR with Maven
        run: mvn clean package -DskipTests

      - name: Verify JAR exists
        run: |
          JAR_FILE="target/${{ env.JOB_NAME }}-${{ env.JAR_VERSION }}.jar"
          if [ ! -f "${JAR_FILE}" ]; then
            echo "âŒ JAR æ–‡ä»¶ä¸å­˜åœ¨: ${JAR_FILE}"
            echo "ğŸ“‹ target ç›®å½•å†…å®¹:"
            ls -la target/
            exit 1
          fi
          echo "âœ… JAR æ„å»ºæˆåŠŸ: ${JAR_FILE}"
          echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $(du -h ${JAR_FILE} | cut -f1)"

      # ==============================
      # é˜¶æ®µ 2: ä¸Šä¼  JAR åˆ° OSS
      # ==============================
      - name: Setup Aliyun CLI
        uses: aliyun/setup-aliyun-cli-action@v1
        with:
          aliyun-access-key-id: ${{ secrets.FLINK_ACCESS_KEY }}
          aliyun-access-key-secret: ${{ secrets.FLINK_ACCESS_SECRET }}
          aliyun-region: ${{ env.OSS_REGION }}

      - name: Upload JAR to OSS
        run: |
          JAR_FILE="target/${{ env.JOB_NAME }}-${{ env.JAR_VERSION }}.jar"
          OSS_JAR_PATH="oss://${{ env.OSS_BUCKET }}/artifacts/namespaces/${{ env.NAMESPACE }}/jars/${{ env.JOB_NAME }}/${{ env.JOB_NAME }}-${{ env.JAR_VERSION }}.jar"

          echo "ğŸ“¤ ä¸Šä¼  JAR åˆ° OSS..."
          echo "   æºæ–‡ä»¶: ${JAR_FILE}"
          echo "   ç›®æ ‡è·¯å¾„: ${OSS_JAR_PATH}"

          aliyun oss cp "${JAR_FILE}" "${OSS_JAR_PATH}" --force

          echo "âœ… JAR ä¸Šä¼ æˆåŠŸ"

          # å°† OSS è·¯å¾„ä¿å­˜ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "OSS_JAR_PATH=${OSS_JAR_PATH}" >> $GITHUB_ENV

      - name: Upload deploy config to OSS
        run: |
          CONFIG_FILE="src/main/deploy/job-args-dev.yml"
          OSS_CONFIG_PATH="oss://${{ env.OSS_BUCKET }}/artifacts/namespaces/${{ env.NAMESPACE }}/configs/${{ env.JOB_NAME }}/job-args-dev.yml"

          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²é…ç½®åˆ° OSS..."
          aliyun oss cp "${CONFIG_FILE}" "${OSS_CONFIG_PATH}" --force
          echo "âœ… éƒ¨ç½²é…ç½®ä¸Šä¼ æˆåŠŸ"

      # ==============================
      # é˜¶æ®µ 3: éƒ¨ç½²åˆ° Flink
      # ==============================
      - name: Read deploy config
        id: config
        run: |
          CONFIG_FILE="src/main/deploy/job-args-dev.yml"
          echo "ğŸ“– è¯»å–éƒ¨ç½²é…ç½®: ${CONFIG_FILE}"

          # ä½¿ç”¨ grep + sed ä» YAML ä¸­æå–å€¼ (æ— éœ€é¢å¤–ä¾èµ–)
          get_yaml_value() {
            grep "^${1}:" "${CONFIG_FILE}" | sed "s/^${1}:[[:space:]]*//" | sed 's/[[:space:]]*#.*//' | tr -d '"'
          }

          PARALLELISM=$(get_yaml_value "parallelism")
          JM_CPU=$(get_yaml_value "jobmanager_cpu")
          JM_MEM=$(get_yaml_value "jobmanager_memory")
          TM_CPU=$(get_yaml_value "taskmanager_cpu")
          TM_MEM=$(get_yaml_value "taskmanager_memory")
          ENTRY_CLASS=$(get_yaml_value "entry_class")

          echo "parallelism=${PARALLELISM}" >> $GITHUB_OUTPUT
          echo "jm_cpu=${JM_CPU}" >> $GITHUB_OUTPUT
          echo "jm_mem=${JM_MEM}" >> $GITHUB_OUTPUT
          echo "tm_cpu=${TM_CPU}" >> $GITHUB_OUTPUT
          echo "tm_mem=${TM_MEM}" >> $GITHUB_OUTPUT
          echo "entry_class=${ENTRY_CLASS}" >> $GITHUB_OUTPUT

          echo "ğŸ“‹ éƒ¨ç½²å‚æ•°:"
          echo "   å¹¶è¡Œåº¦: ${PARALLELISM}"
          echo "   JM CPU/MEM: ${JM_CPU} / ${JM_MEM}"
          echo "   TM CPU/MEM: ${TM_CPU} / ${TM_MEM}"
          echo "   å…¥å£ç±»: ${ENTRY_CLASS}"

      - name: Deploy to Aliyun Flink
        env:
          ENTRY_CLASS: ${{ steps.config.outputs.entry_class }}
          PARALLELISM: ${{ steps.config.outputs.parallelism }}
          JM_CPU: ${{ steps.config.outputs.jm_cpu }}
          JM_MEM: ${{ steps.config.outputs.jm_mem }}
          TM_CPU: ${{ steps.config.outputs.tm_cpu }}
          TM_MEM: ${{ steps.config.outputs.tm_mem }}
        run: |
          echo "ğŸš€ éƒ¨ç½² Flink ä½œä¸šåˆ°é˜¿é‡Œäº‘..."
          echo "   Workspace: ${{ env.WORKSPACE }}"
          echo "   Namespace: ${{ env.NAMESPACE }}"
          echo "   JAR: ${OSS_JAR_PATH}"
          echo "   å…¥å£ç±»: ${ENTRY_CLASS}"

          # è°ƒç”¨é˜¿é‡Œäº‘ Flink å…¨æ‰˜ç®¡ API åˆ›å»ºéƒ¨ç½²
          DEPLOY_RESULT=$(aliyun stvs CreateDeployment \
            --region ${{ env.FLINK_REGION }} \
            --workspace ${{ env.WORKSPACE }} \
            --namespace ${{ env.NAMESPACE }} \
            --body '{
              "metadata": {
                "name": "'${{ env.JOB_NAME }}'",
                "namespace": "'${{ env.NAMESPACE }}'"
              },
              "spec": {
                "deploymentKind": "STREAMING",
                "state": "RUNNING",
                "template": {
                  "spec": {
                    "artifact": {
                      "kind": "JAR",
                      "jarUri": "'"${OSS_JAR_PATH}"'",
                      "entryClass": "'"${ENTRY_CLASS}"'"
                    },
                    "flinkConfiguration": {
                      "parallelism.default": "'"${PARALLELISM}"'",
                      "jobmanager.memory.process.size": "'"${JM_MEM}"'",
                      "taskmanager.memory.process.size": "'"${TM_MEM}"'",
                      "jobmanager.cpu.cores": "'"${JM_CPU}"'",
                      "taskmanager.cpu.cores": "'"${TM_CPU}"'"
                    },
                    "resources": {
                      "jobmanager": {
                        "cpu": '"${JM_CPU}"',
                        "memory": "'"${JM_MEM}"'"
                      },
                      "taskmanager": {
                        "cpu": '"${TM_CPU}"',
                        "memory": "'"${TM_MEM}"'"
                      }
                    }
                  }
                },
                "engineVersion": "'${{ env.FLINK_ENGINE_VERSION }}'"
              }
            }' 2>&1) || {
              echo "âŒ CreateDeployment å¤±è´¥"
              echo "${DEPLOY_RESULT}"
              exit 1
            }

          echo "âœ… Flink éƒ¨ç½²åˆ›å»ºæˆåŠŸ"
          echo "${DEPLOY_RESULT}"

          # æå– Deployment ID
          DEPLOYMENT_ID=$(echo "${DEPLOY_RESULT}" | jq -r '.metadata.id // empty')
          if [ -n "${DEPLOYMENT_ID}" ]; then
            echo "ğŸ“Œ Deployment ID: ${DEPLOYMENT_ID}"
            echo "DEPLOYMENT_ID=${DEPLOYMENT_ID}" >> $GITHUB_ENV
          fi

      - name: Verify Flink deployment
        if: env.DEPLOYMENT_ID != ''
        run: |
          echo "ğŸ” éªŒè¯ Flink éƒ¨ç½²çŠ¶æ€..."
          echo "   Deployment ID: ${DEPLOYMENT_ID}"

          # ç­‰å¾…éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 10

          DEPLOY_STATUS=$(aliyun stvs GetDeployment \
            --region ${{ env.FLINK_REGION }} \
            --workspace ${{ env.WORKSPACE }} \
            --namespace ${{ env.NAMESPACE }} \
            --deploymentId "${DEPLOYMENT_ID}" 2>&1) || {
              echo "âš ï¸ è·å–éƒ¨ç½²çŠ¶æ€å¤±è´¥ (å¯èƒ½å°šæœªå°±ç»ª)"
              echo "${DEPLOY_STATUS}"
              exit 0
            }

          STATE=$(echo "${DEPLOY_STATUS}" | jq -r '.spec.state // "UNKNOWN"')
          echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€: ${STATE}"

          if [ "${STATE}" = "RUNNING" ] || [ "${STATE}" = "TRANSITIONING" ]; then
            echo "âœ… Flink ä½œä¸šéƒ¨ç½²éªŒè¯é€šè¿‡"
          else
            echo "âš ï¸ å½“å‰çŠ¶æ€ä¸º ${STATE}ï¼Œå¯èƒ½ä»åœ¨å¯åŠ¨ä¸­ (è¿™åœ¨ POC ä¸­æ˜¯æ­£å¸¸çš„)"
          fi

      # ==============================
      # éƒ¨ç½²æ±‡æ€»
      # ==============================
      - name: Deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸš€ Flink éƒ¨ç½²æ±‡æ€»

          | é¡¹ç›® | å€¼ |
          |------|-----|
          | **ç¯å¢ƒ** | ${{ env.ENVIRONMENT }} |
          | **ä½œä¸šåç§°** | ${{ env.JOB_NAME }} |
          | **JAR ç‰ˆæœ¬** | ${{ env.JAR_VERSION }} |
          | **Commit** | ${{ github.sha }} |

          ## éƒ¨ç½²äº§ç‰©
          | æ­¥éª¤ | çŠ¶æ€ |
          |------|------|
          | Maven æ„å»º | âœ… |
          | OSS ä¸Šä¼  | JAR + Config |
          | Flink éƒ¨ç½² | å·²æäº¤ |
          EOF

# ========================================
# GitHub Secrets é…ç½®è¯´æ˜
# ========================================
# éœ€è¦åœ¨ GitHub ä»“åº“ Settings > Secrets ä¸­é…ç½®:
#
# ALIYUN_ACCESS_KEY_ID      - é˜¿é‡Œäº‘ AccessKey ID
# ALIYUN_ACCESS_KEY_SECRET  - é˜¿é‡Œäº‘ AccessKey Secret
