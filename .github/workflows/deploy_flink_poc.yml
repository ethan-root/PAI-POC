# ========================================================
# POC: GitHub Action ÈÉ®ÁΩ≤ Flink JAR Âà∞ÈòøÈáå‰∫ë
# ========================================================
# ÂÆåÂÖ®Áã¨Á´ãÔºå‰∏ç‰æùËµñ‰ªª‰Ωï Kering ÂÜÖÈÉ®ÁªÑ‰ª∂
#
# ÂâçÁΩÆÊù°‰ª∂:
# 1. Âú® GitHub Secrets ÈÖçÁΩÆ: FLINK_ACCESS_KEY, FLINK_ACCESS_SECRET
# 2. Âú® GitHub Secrets ÈÖçÁΩÆ: FLINK_OSS_BUCKET, FLINK_OSS_REGION, FLINK_WORKSPACE, FLINK_NAMESPACE, FLINK_REGION
# 3. JAR Â∑≤‰∏ä‰º†Âà∞ OSSÔºàÊú¨ÊµÅÊ∞¥Á∫ø‰ºöËá™Âä®‰∏ä‰º†Ôºâ

name: POC - Deploy Flink to Aliyun

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy_flink_poc.yml'
  workflow_dispatch:        # ÂÖÅËÆ∏ÊâãÂä®Ëß¶ÂèëÔºàÊé®ËçêÈ¶ñÊ¨°Áî®Ëøô‰∏™Ôºâ

env:
  JOB_NAME: poc-flink-hello-world
  JAR_VERSION: 1.0.0-SNAPSHOT
  ENTRY_CLASS: com.example.flink.HelloWorldFlinkJob

jobs:
  # ==========================================
  # Job 1: ÊûÑÂª∫ JAR ÂåÖ
  # ==========================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Upload JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flink-jar
          path: ./target/poc-flink-hello-world-*.jar
          retention-days: 3

  # ==========================================
  # Job 2: ‰∏ä‰º†Âà∞ OSS Âπ∂ÈÉ®ÁΩ≤Âà∞ Flink
  # ==========================================
  # ==========================================
  # Job 2: ‰∏ä‰º†Âà∞ OSS Âπ∂ÈÉ®ÁΩ≤Âà∞ Flink (Matrix Strategy)
  # ==========================================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - job_name: poc-flink-infinite-job-a
            entry_class: com.example.flink.InfiniteFlinkJobA
          - job_name: poc-flink-infinite-job-b
            entry_class: com.example.flink.InfiniteFlinkJobB

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: flink-jar
          path: ./jars

      - name: List JAR files
        run: ls -la ./jars/

      # ==========================================
      # Step: ÂÆâË£ÖÂπ∂ÈÖçÁΩÆÈòøÈáå‰∫ë CLI
      # ==========================================
      - name: Install Aliyun CLI
        run: |
          echo "üì¶ Installing Aliyun CLI..."
          wget -q https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun version
          echo "‚úÖ Aliyun CLI installed"

      - name: Configure Aliyun CLI
        run: |
          aliyun configure set \
            --profile default \
            --mode AK \
            --region ${{ secrets.FLINK_OSS_REGION }} \
            --access-key-id "${{ secrets.FLINK_ACCESS_KEY }}" \
            --access-key-secret "${{ secrets.FLINK_ACCESS_SECRET }}"
          echo "‚úÖ CLI configured"

      - name: Validate required variables
        run: |
          MISSING=""
          [ -z "${{ secrets.FLINK_OSS_BUCKET }}" ] && MISSING="${MISSING} OSS_BUCKET"
          [ -z "${{ secrets.FLINK_OSS_REGION }}" ] && MISSING="${MISSING} OSS_REGION"
          [ -z "${{ secrets.FLINK_WORKSPACE }}" ] && MISSING="${MISSING} FLINK_WORKSPACE"
          [ -z "${{ secrets.FLINK_NAMESPACE }}" ] && MISSING="${MISSING} FLINK_NAMESPACE"
          [ -z "${{ secrets.FLINK_REGION }}" ] && MISSING="${MISSING} FLINK_REGION"
          if [ -n "$MISSING" ]; then
            echo "‚ùå Missing required GitHub Variables:${MISSING}"
            echo "   ËØ∑Âú® GitHub ‰ªìÂ∫ì Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables ‰∏≠ÈÖçÁΩÆ"
            exit 1
          fi
          echo "‚úÖ All required variables are set"

      # ==========================================
      # Step: ‰∏ä‰º† JAR Âà∞ OSSÔºà‰ΩøÁî® aliyun oss ÂëΩ‰ª§Ôºâ
      # ==========================================
      - name: Upload JAR to OSS
        run: |
          JAR_FILE=$(ls ./jars/*.jar | head -1)
          JAR_FILENAME=$(basename $JAR_FILE)
          echo "Uploading $JAR_FILENAME to OSS..."

          OSS_PATH="oss://${{ secrets.FLINK_OSS_BUCKET }}/artifacts/namespaces/${{ secrets.FLINK_NAMESPACE }}/${JAR_FILENAME}"
          echo "OSS target: $OSS_PATH"

          aliyun oss cp "$JAR_FILE" "$OSS_PATH" -f --region ${{ secrets.FLINK_OSS_REGION }}

          echo "jar_oss_path=$OSS_PATH" >> $GITHUB_ENV
          echo "‚úÖ JAR uploaded successfully"


      # ==========================================
      # Step: ÈÉ®ÁΩ≤ Flink ‰Ωú‰∏öÂà∞ÈòøÈáå‰∫ë Realtime Compute
      # ==========================================
      - name: Deploy Flink Job
        env:
          FLINK_ENDPOINT: ververica.${{ secrets.FLINK_REGION }}.aliyuncs.com
          FLINK_WORKSPACE: ${{ secrets.FLINK_WORKSPACE }}
          FLINK_NAMESPACE: ${{ secrets.FLINK_NAMESPACE }}
          JOB_NAME: ${{ matrix.job_name }}
          ENTRY_CLASS: ${{ matrix.entry_class }}
        run: |
          echo "üöÄ Deploying Flink job: ${{ env.JOB_NAME }}"
          echo "  OSS JAR path: ${jar_oss_path}"
          echo "  Entry class:  ${{ env.ENTRY_CLASS }}"
          echo "  Workspace:    ${FLINK_WORKSPACE}"
          echo "  Namespace:    ${FLINK_NAMESPACE}"

          # ÊûÑÂª∫ÈÉ®ÁΩ≤ËØ∑Ê±Ç bodyÔºà‰ΩøÁî® jq Á°Æ‰øù JSON Ê†ºÂºèÊ≠£Á°ÆÔºâ
          # ‰ΩøÁî® -c ÈÄâÈ°πÁîüÊàêÂéãÁº©ÁöÑ JSON (ÂçïË°å)ÔºåÈÅøÂÖçÈÄöËøá CLI ‰º†ÈÄíÊó∂ÁöÑÊç¢Ë°åÁ¨¶ÈóÆÈ¢ò
          jq -n -c \
            --arg name "${{ env.JOB_NAME }}" \
            --arg ns "${FLINK_NAMESPACE}" \
            --arg jarUri "${jar_oss_path}" \
            --arg entryClass "${{ env.ENTRY_CLASS }}" \
            '{
              kind: "Deployment",
              apiVersion: "v1",
              metadata: { name: $name, namespace: $ns },
              spec: {
                state: "RUNNING",
                template: {
                  spec: {
                    artifact: {
                      kind: "JAR",
                      jarUri: $jarUri,
                      entryClass: $entryClass
                    },
                    parallelism: 1,
                    resources: {
                      jobmanager: { cpu: 0.5, memory: "1Gi" },
                      taskmanager: { cpu: 0.5, memory: "1Gi" }
                    }
                  }
                }
              }
            }' > deployment.json

          echo "üìÑ Deployment config (compact):"
          cat deployment.json

          # Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêç deployment
          echo "üîç Checking for existing deployment..."
          LIST_RESULT=$(aliyun ververica GET \
            "/api/v2/namespaces/${FLINK_NAMESPACE}/deployments" \
            --endpoint "${FLINK_ENDPOINT}" \
            --header "workspace=${FLINK_WORKSPACE}" \
            2>&1) || true

          DEPLOY_ID=$(echo "$LIST_RESULT" | jq -r \
            ".data.deployments[]? | select(.metadata.name==\"${{ env.JOB_NAME }}\") | .metadata.id" \
            2>/dev/null) || DEPLOY_ID=""

          if [ -n "$DEPLOY_ID" ] && [ "$DEPLOY_ID" != "null" ]; then
            echo "üìù Updating existing deployment (ID: ${DEPLOY_ID})..."
            RESULT=$(aliyun ververica PATCH \
              "/api/v2/namespaces/${FLINK_NAMESPACE}/deployments/${DEPLOY_ID}" \
              --endpoint "${FLINK_ENDPOINT}" \
              --header "workspace=${FLINK_WORKSPACE}" \
              --header "Content-Type=application/json" \
              --body "$(cat deployment.json)" 2>&1) 
          else
            echo "üÜï No existing deployment found, creating new one..."
            RESULT=$(aliyun ververica POST \
              "/api/v2/namespaces/${FLINK_NAMESPACE}/deployments" \
              --endpoint "${FLINK_ENDPOINT}" \
              --header "workspace=${FLINK_WORKSPACE}" \
              --header "Content-Type=application/json" \
              --body "$(cat deployment.json)" 2>&1)
          fi
          
          echo "$RESULT" | jq . 2>/dev/null || echo "$RESULT"

          # Ê£ÄÊü• API ËøîÂõûÁöÑ success Â≠óÊÆµ
          IS_SUCCESS=$(echo "$RESULT" | jq -r '.success' 2>/dev/null)
          if [ "$IS_SUCCESS" != "true" ]; then
            echo "‚ùå Flink job deployment failed (API returned success: false)"
            exit 1
          fi

          echo "‚úÖ Flink job deployment completed!"
