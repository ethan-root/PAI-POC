name: Deploy Pipeline (ACR & OSS)

on:
  # ğŸ”´ æ”¹ä¸º Release è§¦å‘ - ä½¿ç”¨ Tag ä½œä¸ºç‰ˆæœ¬å·
  release:
    types: [published]
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (å¦‚: v1.0.0)'
        required: true
        default: 'v0.0.0-test'

# ğŸ”´ å…¨å±€é…ç½®
env:
  # ACR é…ç½® (æ­å·)
  REGISTRY: ${{ secrets.ACR_REGISTRY }}
  NAMESPACE: capgemini-poc
  IMAGE_NAME: pai-poc
  
  # OSS é…ç½® (ä¸Šæµ·)
  OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
  OSS_BUCKET: ${{ secrets.OSS_BUCKET }}

permissions:
  contents: read
  security-events: write

jobs:
  # =========================================================
  # ä»»åŠ¡ 0: ç‰ˆæœ¬å·è§£æ
  # =========================================================
  prepare:
    name: ğŸ“‹ Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.tag }}
      image_uri: ${{ steps.version.outputs.image_uri }}
    steps:
      - name: Extract Version Tag
        id: version
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
        run: |
          # ä¼˜å…ˆä½¿ç”¨ Release Tagï¼Œå¦åˆ™ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.version_tag }}"
          fi
          
          # æ£€æŸ¥ VERSION æ˜¯å¦ä¸ºç©º
          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·ä¸ºç©ºï¼"
            echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
            exit 1
          fi
          
          # æ£€æŸ¥ REGISTRY æ˜¯å¦ä¸ºç©º
          if [ -z "$REGISTRY" ]; then
            echo "âŒ é”™è¯¯: ACR_REGISTRY secret æœªè®¾ç½®ï¼"
            exit 1
          fi
          
          # æ„å»ºå®Œæ•´é•œåƒåœ°å€
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ ç‰ˆæœ¬å·: ${VERSION}"
          echo "ğŸ³ é•œåƒåœ°å€: ${IMAGE_URI}"

  # =========================================================
  # ä»»åŠ¡ 1: å®‰å…¨æ‰«æ (CodeQL)
  # =========================================================
  analyze-security:
    name: ğŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: 'python'
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # =========================================================
  # ä»»åŠ¡ 2: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  # =========================================================
  build-and-push-acr:
    name: ğŸ³ Build & Push to ACR
    needs: [prepare, analyze-security]
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ needs.prepare.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push
        run: |
          IMAGE_URI="${{ needs.prepare.outputs.image_uri }}"
          
          echo "ğŸ”¨ æ„å»ºé•œåƒ: ${IMAGE_URI}"
          docker build -t "${IMAGE_URI}" .
          
          echo "ğŸ“¤ æ¨é€é•œåƒ..."
          docker push "${IMAGE_URI}"
          
          echo "âœ… é•œåƒæ¨é€æˆåŠŸ: ${IMAGE_URI}"

      # ğŸ†• éƒ¨ç½²çŠ¶æ€æ£€æŸ¥ - éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
      - name: Verify Image Push
        run: |
          echo "ğŸ” éªŒè¯é•œåƒæ¨é€çŠ¶æ€..."
          
          # ä½¿ç”¨ docker manifest æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
          if docker manifest inspect "${{ needs.prepare.outputs.image_uri }}" > /dev/null 2>&1; then
            echo "âœ… é•œåƒéªŒè¯æˆåŠŸ: ${{ needs.prepare.outputs.image_uri }}"
          else
            echo "âŒ é•œåƒéªŒè¯å¤±è´¥ï¼Œå¯èƒ½æ¨é€æœªå®Œæˆ"
            exit 1
          fi

  # =========================================================
  # ä»»åŠ¡ 3: ä¸Šä¼ ä»£ç åˆ° OSS (ä¼˜åŒ–ç‰ˆ)
  # =========================================================
  upload-to-oss:
    name: â˜ï¸ Upload to OSS
    needs: [prepare, analyze-security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OSS Tool
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: "${{ env.OSS_ENDPOINT }}"
          access-key-id: "${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
          access-key-secret: "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

      # ğŸ†• ä¼˜åŒ–: åªä¸Šä¼ å¿…è¦æ–‡ä»¶
      - name: Prepare Upload Files
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo "ğŸ“ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾è¦ä¸Šä¼ çš„æ–‡ä»¶
          mkdir -p .upload_staging
          
          # åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶ (æ’é™¤ .git, .github, .gitignore ç­‰)
          cp -r main.py .upload_staging/ 2>/dev/null || true
          cp -r Dockerfile .upload_staging/ 2>/dev/null || true
          cp -r requirements.txt .upload_staging/ 2>/dev/null || true
          cp -r src/ .upload_staging/ 2>/dev/null || true
          cp -r app/ .upload_staging/ 2>/dev/null || true
          cp -r config/ .upload_staging/ 2>/dev/null || true
          
          # åˆ›å»ºç‰ˆæœ¬å…ƒæ•°æ®æ–‡ä»¶
          cat > .upload_staging/manifest.json << EOF
          {
            "version": "${VERSION}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "release_url": "${{ github.event.release.html_url }}",
            "image_uri": "${{ needs.prepare.outputs.image_uri }}"
          }
          EOF
          
          echo "ğŸ“‹ å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨:"
          ls -la .upload_staging/

      - name: Upload to OSS
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          OSS_PATH="oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/"
          
          echo "ğŸ“¤ ä¸Šä¼ åˆ°: ${OSS_PATH}"
          
          # ä¸Šä¼ æ–‡ä»¶
          ossutil cp -r .upload_staging/ "${OSS_PATH}" --include "*"
          
          echo "âœ… ä»£ç ä¸Šä¼ æˆåŠŸ"

      # ğŸ†• æ›´æ–° latest æŒ‡é’ˆæ–‡ä»¶
      - name: Update Latest Pointer
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # åˆ›å»º latest.txt æŒ‡é’ˆ
          echo "${VERSION}" > latest.txt
          ossutil cp latest.txt "oss://${{ env.OSS_BUCKET }}/releases/latest.txt" -f
          
          # åˆ›å»º latest.json åŒ…å«æ›´å¤šä¿¡æ¯
          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "image_uri": "${{ needs.prepare.outputs.image_uri }}",
            "oss_path": "releases/${VERSION}/"
          }
          EOF
          ossutil cp latest.json "oss://${{ env.OSS_BUCKET }}/releases/latest.json" -f
          
          echo "âœ… Latest æŒ‡é’ˆæ›´æ–°å®Œæˆ"

      # ğŸ†• éƒ¨ç½²çŠ¶æ€æ£€æŸ¥ - éªŒè¯ OSS ä¸Šä¼ 
      - name: Verify OSS Upload
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo "ğŸ” éªŒè¯ OSS ä¸Šä¼ çŠ¶æ€..."
          
          # åˆ—å‡ºä¸Šä¼ çš„æ–‡ä»¶
          ossutil ls "oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/" --limited-num 20
          
          # æ£€æŸ¥ manifest.json æ˜¯å¦å­˜åœ¨
          if ossutil stat "oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/manifest.json" > /dev/null 2>&1; then
            echo "âœ… OSS ä¸Šä¼ éªŒè¯æˆåŠŸ"
          else
            echo "âŒ OSS ä¸Šä¼ éªŒè¯å¤±è´¥"
            exit 1
          fi

  # =========================================================
  # ä»»åŠ¡ 4: éƒ¨ç½²çŠ¶æ€æ±‡æ€»
  # =========================================================
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: [prepare, build-and-push-acr, upload-to-oss]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          IMAGE_URI="${{ needs.prepare.outputs.image_uri }}"
          
          echo "# ğŸš€ éƒ¨ç½²çŠ¶æ€æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **ç‰ˆæœ¬å·** | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **è§¦å‘æ–¹å¼** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## éƒ¨ç½²äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "| äº§ç‰© | åœ°å€ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          # ACR çŠ¶æ€
          if [ "${{ needs.build-and-push-acr.result }}" == "success" ]; then
            echo "| ğŸ³ Docker é•œåƒ | \`${IMAGE_URI}\` | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ³ Docker é•œåƒ | \`${IMAGE_URI}\` | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # OSS çŠ¶æ€
          if [ "${{ needs.upload-to-oss.result }}" == "success" ]; then
            echo "| â˜ï¸ OSS ä»£ç åŒ… | \`releases/${VERSION}/\` | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â˜ï¸ OSS ä»£ç åŒ… | \`releases/${VERSION}/\` | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "- PAI EAS æœåŠ¡éœ€è¦æ‰‹åŠ¨æ›´æ–°æˆ–é€šè¿‡åç»­æµæ°´çº¿è‡ªåŠ¨æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "- DataWorks å¯é€šè¿‡è¯»å– \`releases/latest.txt\` è·å–æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        if: needs.build-and-push-acr.result != 'success' || needs.upload-to-oss.result != 'success'
        run: |
          echo "âŒ éƒ¨ç½²å­˜åœ¨å¤±è´¥é¡¹ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1