name: Deploy Pipeline (ACR & OSS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# ğŸ”´ å…¨å±€é…ç½®
env:
  # æ‚¨çš„ ACR é•œåƒåœ°å€ (æ­å·)
  REGISTRY: ${{ secrets.ACR_REGISTRY }}
  NAMESPACE: capgemini-poc
  IMAGE_NAME: pai-poc
  
  # ğŸ”´ å…³é”®ä¿®å¤ 1: OSS å¿…é¡»æŒ‡å‘ä¸Šæµ· (æ ¹æ®ä¹‹å‰çš„æŠ¥é”™ä¿®æ­£)
  # å¦‚æœæ‚¨çš„ secrets.OSS_ENDPOINT é‡Œå­˜çš„æ˜¯æ­å·ï¼Œè¯·åŠ¡å¿…åœ¨è¿™é‡Œç¡¬ç¼–ç è¦†ç›–å®ƒï¼Œæˆ–è€…å» Secrets é‡Œæ”¹æˆä¸Šæµ·
  OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
  OSS_BUCKET: ${{ secrets.OSS_BUCKET }}

permissions:
  contents: read
  security-events: write

jobs:
  # =========================================================
  # ä»»åŠ¡ 1: å®‰å…¨æ‰«æ (CodeQL)
  # =========================================================
  analyze-security:
    name: ğŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: 'python'
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # =========================================================
  # ä»»åŠ¡ 2: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  # ğŸ”´ å…³é”®ä¿®å¤ 2: ä½¿ç”¨ ACR ä¸“ç”¨è´¦å·å¯†ç 
  # =========================================================
  build-and-push-acr:
    needs: analyze-security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to ACR (ä½¿ç”¨å›ºå®šå¯†ç )
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          # è¿™é‡Œæ”¹ç”¨æ‚¨æ–°åŠ çš„ ACR ä¸“ç”¨å˜é‡
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"
          echo "âœ… é•œåƒæ¨é€æˆåŠŸ"

  # =========================================================
  # ä»»åŠ¡ 3: ä¸Šä¼ ä»£ç åˆ° OSS
  # ä½¿ç”¨ AK/SK (ä¿æŒä¸å˜)
  # =========================================================
  upload-to-oss:
    needs: analyze-security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OSS Tool
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          # ç¡®ä¿è¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸Šé¢ env å®šä¹‰çš„ä¸Šæµ· Endpoint
          endpoint: "${{ env.OSS_ENDPOINT }}"
          # è¿™é‡Œç»§ç»­ç”¨ AK/SKï¼Œå› ä¸º ossutil éœ€è¦è¿™ä¸ª
          access-key-id: "${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
          access-key-secret: "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

      - name: Upload Code
        run: |
          OSS_PATH="oss://${{ env.OSS_BUCKET }}/releases/${{ github.sha }}/"
          ossutil cp -r . "$OSS_PATH"
          echo "âœ… ä»£ç ä¸Šä¼ æˆåŠŸ"