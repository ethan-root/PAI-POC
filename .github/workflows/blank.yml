name: Deploy Pipeline (ACR & OSS)

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (å¦‚: v1.0.0)'
        required: true
        default: 'v0.0.0-test'

env:
  REGISTRY: ${{ secrets.ACR_REGISTRY }}
  NAMESPACE: capgemini-poc
  IMAGE_NAME: pai-poc
  OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
  OSS_BUCKET: ${{ secrets.OSS_BUCKET }}

permissions:
  contents: read
  security-events: write

jobs:
  prepare:
    name: ðŸ“‹ Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.tag }}
    steps:
      - name: Extract Version Tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ github.event.inputs.version_tag }}"
          fi
          
          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·ä¸ºç©ºï¼"
            echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
            exit 1
          fi
          
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ç‰ˆæœ¬å·: ${VERSION}"

  analyze-security:
    name: ðŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v4
        with:
          languages: 'python'
      - uses: github/codeql-action/autobuild@v4
      - uses: github/codeql-action/analyze@v4

  build-and-push-acr:
    name: ðŸ³ Build & Push to ACR
    needs: [prepare, analyze-security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          echo "ðŸ”¨ æž„å»ºé•œåƒ: ${IMAGE_URI}"
          docker build -t "${IMAGE_URI}" .
          echo "ðŸ“¤ æŽ¨é€é•œåƒ..."
          docker push "${IMAGE_URI}"
          echo "âœ… é•œåƒæŽ¨é€æˆåŠŸ: ${IMAGE_URI}"

      - name: Verify Image Push
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          echo "ðŸ” éªŒè¯é•œåƒæŽ¨é€çŠ¶æ€..."
          if docker manifest inspect "${IMAGE_URI}" > /dev/null 2>&1; then
            echo "âœ… é•œåƒéªŒè¯æˆåŠŸ: ${IMAGE_URI}"
          else
            echo "âŒ é•œåƒéªŒè¯å¤±è´¥"
            exit 1
          fi

  upload-to-oss:
    name: â˜ï¸ Upload to OSS
    needs: [prepare, analyze-security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OSS Tool
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: "${{ env.OSS_ENDPOINT }}"
          access-key-id: "${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
          access-key-secret: "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

      - name: Prepare Upload Files
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          mkdir -p .upload_staging
          cp -r main.py .upload_staging/ 2>/dev/null || true
          cp -r Dockerfile .upload_staging/ 2>/dev/null || true
          cp -r requirements.txt .upload_staging/ 2>/dev/null || true
          cp -r src/ .upload_staging/ 2>/dev/null || true
          cp -r app/ .upload_staging/ 2>/dev/null || true
          cp -r config/ .upload_staging/ 2>/dev/null || true
          
          cat > .upload_staging/manifest.json << EOF
          {
            "version": "${VERSION}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "release_url": "${{ github.event.release.html_url }}",
            "image_uri": "${IMAGE_URI}"
          }
          EOF
          
          echo "ðŸ“‹ å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨:"
          ls -la .upload_staging/

      - name: Upload to OSS
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          OSS_PATH="oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/"
          echo "ðŸ“¤ ä¸Šä¼ åˆ°: ${OSS_PATH}"
          ossutil cp -r .upload_staging/ "${OSS_PATH}" --include "*"
          echo "âœ… ä»£ç ä¸Šä¼ æˆåŠŸ"

      - name: Update Latest Pointer
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          echo "${VERSION}" > latest.txt
          ossutil cp latest.txt "oss://${{ env.OSS_BUCKET }}/releases/latest.txt" -f
          
          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "image_uri": "${IMAGE_URI}",
            "oss_path": "releases/${VERSION}/"
          }
          EOF
          ossutil cp latest.json "oss://${{ env.OSS_BUCKET }}/releases/latest.json" -f
          echo "âœ… Latest æŒ‡é’ˆæ›´æ–°å®Œæˆ"

      - name: Verify OSS Upload
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ðŸ” éªŒè¯ OSS ä¸Šä¼ çŠ¶æ€..."
          ossutil ls "oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/" --limited-num 20
          
          if ossutil stat "oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/manifest.json" > /dev/null 2>&1; then
            echo "âœ… OSS ä¸Šä¼ éªŒè¯æˆåŠŸ"
          else
            echo "âŒ OSS ä¸Šä¼ éªŒè¯å¤±è´¥"
            exit 1
          fi

  # =========================================================
  # ä»»åŠ¡ 4: æ›´æ–° PAI EAS æœåŠ¡ (ä½¿ç”¨ OpenAPI)
  # =========================================================
  update-pai-service:
    name: ðŸš€ Update PAI EAS Service
    needs: [prepare, build-and-push-acr]
    runs-on: ubuntu-latest
    if: needs.build-and-push-acr.result == 'success'
    steps:
      - name: Prepare Service Update Payload
        env:
          ACR_REGISTRY_VPC: crpi-gse517a1fwz5v90b-vpc.cn-hangzhou.personal.cr.aliyuncs.com
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          IMAGE_URI="${ACR_REGISTRY_VPC}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          DOCKER_AUTH=$(echo -n "${ACR_USERNAME}:${ACR_PASSWORD}" | base64 -w 0)
          
          cat > update_payload.json << EOF
          {
            "metadata": {
              "workspace_id": "556368"
            },
            "containers": [
              {
                "image": "${IMAGE_URI}",
                "port": 8000,
                "script": "python app.py"
              }
            ],
            "dockerAuth": "${DOCKER_AUTH}"
          }
          EOF
          
          echo "ðŸ“„ æœåŠ¡æ›´æ–°é…ç½®:"
          cat update_payload.json
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      - name: Install Aliyun CLI
        run: |
          echo "ðŸ“¦ å®‰è£… Aliyun CLI..."
          wget -q https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun version
          echo "âœ… Aliyun CLI å®‰è£…å®Œæˆ"

      - name: Configure Aliyun CLI
        env:
          ALIYUN_AK: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_SK: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
        run: |
          echo "ðŸ”‘ é…ç½® Aliyun CLI è®¤è¯..."
          aliyun configure set \
            --profile default \
            --mode AK \
            --region cn-hangzhou \
            --access-key-id "${ALIYUN_AK}" \
            --access-key-secret "${ALIYUN_SK}"
          echo "âœ… è®¤è¯é…ç½®å®Œæˆ"
      
      - name: Install PAI Plugin
        run: |
          echo "ðŸ”Œ å®‰è£… PAI CLI æ’ä»¶..."
          aliyun plugin install pai --force
          echo "âœ… PAI æ’ä»¶å®‰è£…å®Œæˆ"
          
          echo "ðŸ” éªŒè¯ PAI EAS æƒé™..."
          if aliyun pai ListServices --region cn-hangzhou --PageSize 1 > /dev/null 2>&1; then
            echo "âœ… CLI æƒé™éªŒè¯é€šè¿‡"
          else
            echo "âŒ CLI æƒé™éªŒè¯å¤±è´¥ï¼è¯·æ£€æŸ¥ RAM ç”¨æˆ·æ˜¯å¦æŽˆæƒ AliyunPAIEASFullAccess"
            exit 1
          fi

      - name: Update PAI-EAS Service via API
        env:
          SERVICE_NAME: pai_poc
        run: |
          echo "ðŸš€ æ›´æ–° PAI-EAS æœåŠ¡: ${SERVICE_NAME}"
          
          NEW_IMAGE=$(jq -r '.containers[0].image' update_payload.json)
          DOCKER_AUTH=$(jq -r '.dockerAuth' update_payload.json)
          echo "ðŸ“¦ æ–°é•œåƒ: ${NEW_IMAGE}"
          echo "ðŸ”‘ è®¤è¯ä¿¡æ¯: ${DOCKER_AUTH:0:20}..."
          
          echo "ðŸ“¡ èŽ·å–å½“å‰æœåŠ¡é…ç½®..."
          CURRENT_CONFIG=$(aliyun pai DescribeService \
            --region cn-hangzhou \
            --ServiceName "${SERVICE_NAME}" 2>&1) || { 
              echo "âŒ DescribeService å¤±è´¥"; 
              echo "$CURRENT_CONFIG"; 
              exit 1; 
            }
          
          echo "âœ… å½“å‰é…ç½®èŽ·å–æˆåŠŸ"
          
          # ä¿ç•™å®Œæ•´æœåŠ¡é…ç½®ï¼Œåªæ›´æ–°é•œåƒå’Œè®¤è¯ä¿¡æ¯
          UPDATED_CONFIG=$(echo "$CURRENT_CONFIG" | jq \
            --arg new_image "$NEW_IMAGE" \
            --arg docker_auth "$DOCKER_AUTH" \
            '
            .containers[0].image = $new_image | 
            .dockerAuth = $docker_auth |
            # ç¡®ä¿ä¿ç•™æ‰€æœ‰å¿…éœ€å­—æ®µ
            .autoscaler //= {} |
            .cloud //= {} |
            .metadata //= {}
            ')
          
          echo "$UPDATED_CONFIG" > updated_service.json
          
          echo "ðŸ“„ æ›´æ–°åŽçš„å…³é”®é…ç½®:"
          echo "  é•œåƒ: $(echo "$UPDATED_CONFIG" | jq -r '.containers[0].image')"
          echo "  å®žä¾‹æ•°: $(echo "$UPDATED_CONFIG" | jq -r '.metadata.instance')"
          echo "  CPU: $(echo "$UPDATED_CONFIG" | jq -r '.metadata.cpu')"
          echo "  å†…å­˜: $(echo "$UPDATED_CONFIG" | jq -r '.metadata.memory')"
          echo "  æœ€å°å‰¯æœ¬: $(echo "$UPDATED_CONFIG" | jq -r '.autoscaler.min')"
          echo "  æœ€å¤§å‰¯æœ¬: $(echo "$UPDATED_CONFIG" | jq -r '.autoscaler.max')"
          
          echo "ðŸ“¡ æäº¤æœåŠ¡æ›´æ–°..."
          UPDATE_RESULT=$(aliyun pai UpdateService \
            --region cn-hangzhou \
            --ServiceName "${SERVICE_NAME}" \
            --body "$(cat updated_service.json)" 2>&1) || { 
              echo "âŒ UpdateService å¤±è´¥"; 
              echo "$UPDATE_RESULT"; 
              echo ""; 
              echo "ðŸ“‹ è¯·æ£€æŸ¥æ›´æ–°é…ç½®:"; 
              cat updated_service.json | jq '.'; 
              exit 1; 
            }
          
          echo "âœ… æœåŠ¡æ›´æ–°æˆåŠŸ"
          echo "$UPDATE_RESULT"

      - name: Verify Service Status
        env:
          SERVICE_URL: http://1163399701075022.cn-hangzhou.pai-eas.aliyuncs.com/api/predict/pai_poc
          EAS_TOKEN: ${{ secrets.PAI_EAS_TOKEN }}
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡æ›´æ–°ç”Ÿæ•ˆ (45ç§’)..."
          sleep 45
          
          echo "ðŸ” éªŒè¯æœåŠ¡å¥åº·çŠ¶æ€..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SERVICE_URL}" \
            -H "Authorization: ${EAS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"test": "health_check"}' || echo "000")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "ðŸ“Š HTTP çŠ¶æ€ç : ${HTTP_CODE}"
          echo "ðŸ“„ å“åº”å†…å®¹: ${BODY:0:200}"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… æœåŠ¡éªŒè¯æˆåŠŸï¼Œå½“å‰é•œåƒ: ${IMAGE_URI}"
          else
            echo "âš ï¸ æœåŠ¡å“åº”å¼‚å¸¸ (HTTP ${HTTP_CODE})ï¼Œå¯èƒ½æ­£åœ¨å¯åŠ¨ä¸­"
          fi

  deployment-summary:
    name: ðŸ“Š Deployment Summary
    needs: [prepare, build-and-push-acr, upload-to-oss, update-pai-service]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ éƒ¨ç½²çŠ¶æ€æ±‡æ€»
          
          ## ç‰ˆæœ¬ä¿¡æ¯
          | é¡¹ç›® | å€¼ |
          |------|-----|
          | **ç‰ˆæœ¬å·** | \`${VERSION}\` |
          | **Commit SHA** | \`${{ github.sha }}\` |
          | **è§¦å‘æ–¹å¼** | ${{ github.event_name }} |
          
          ## éƒ¨ç½²äº§ç‰©
          | äº§ç‰© | åœ°å€ | çŠ¶æ€ |
          |------|------|------|
          | ðŸ³ Docker é•œåƒ | \`${IMAGE_URI}\` | ${{ needs.build-and-push-acr.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | â˜ï¸ OSS ä»£ç åŒ… | \`releases/${VERSION}/\` | ${{ needs.upload-to-oss.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | ðŸ¤– PAI EAS æœåŠ¡ | \`pai_poc\` | ${{ needs.update-pai-service.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          
          ## å…³é”®ä¿®å¤è¯´æ˜Ž
          - âœ… CLI å‘½ä»¤å‰ç¼€ä¿®æ­£: \`aliyun eas\` â†’ \`aliyun pai\` (ç¬¦åˆé˜¿é‡Œäº‘å®˜æ–¹è§„èŒƒ)
          - âœ… API å¤±è´¥å¼ºåˆ¶é€€å‡º: æ‰€æœ‰ PAI API è°ƒç”¨å¤±è´¥æ—¶ç«‹å³ç»ˆæ­¢ä»»åŠ¡
          - âœ… æƒé™éªŒè¯æ­¥éª¤: æ–°å¢ž ListServices æƒé™é¢„æ£€ï¼Œæå‰æš´éœ²æƒé™é—®é¢˜
          - âœ… VPC åœ°å€ä¿ç•™: personal.cr.aliyuncs.com æ ¼å¼ä¸Žå®žé™…æœåŠ¡é…ç½®å®Œå…¨ä¸€è‡´
          
          ## ä¸‹ä¸€æ­¥æ“ä½œ
          - DataWorks å¯é€šè¿‡è¯»å– \`releases/latest.txt\` èŽ·å–æœ€æ–°ç‰ˆæœ¬
          - æœåŠ¡ç›‘æŽ§: PAI EAS æŽ§åˆ¶å°
          EOF

      - name: Check Overall Status
        if: |
          needs.build-and-push-acr.result != 'success' || 
          needs.upload-to-oss.result != 'success' ||
          needs.update-pai-service.result != 'success'
        run: |
          echo "âŒ éƒ¨ç½²å­˜åœ¨å¤±è´¥é¡¹ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1