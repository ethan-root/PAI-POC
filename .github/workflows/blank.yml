name: Deploy Pipeline with Security Gate

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  # å…¨å±€å˜é‡é…ç½®
  REGION_ID: cn-hangzhou
  REGISTRY: crpi-gse517a1fwz5v90b.cn-hangzhou.personal.cr.aliyuncs.com
  NAMESPACE: capgemini-poc
  IMAGE_NAME: pai-poc
  OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
  OSS_ENDPOINT: oss-cn-hangzhou.aliyuncs.com

permissions:
  contents: read
  security-events: write

jobs:
  # =========================================================
  # ä»»åŠ¡ 1: ä»£ç å®‰å…¨æ‰«æ (é—¨ç¦)
  # =========================================================
  analyze-security:
    name: ğŸ›¡ï¸ Security Gate (CodeQL)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'python'

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform Analysis
        uses: github/codeql-action/analyze@v3

  # =========================================================
  # ä»»åŠ¡ 2: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  # å…³é”®ç‚¹: å¢åŠ äº† needs ä¾èµ–
  # =========================================================
  build-and-push-acr:
    needs: analyze-security  # â›”ï¸ åªæœ‰å½“æ‰«æé€šè¿‡ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸€æ­¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          password: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: Build and Push
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          docker build -t "$IMAGE_TAG" .
          docker push "$IMAGE_TAG"
          echo "âœ… é•œåƒæ¨é€æˆåŠŸ"

  # =========================================================
  # ä»»åŠ¡ 3: ä¸Šä¼ ä»£ç åˆ° OSS
  # å…³é”®ç‚¹: å¢åŠ äº† needs ä¾èµ–
  # =========================================================
  upload-to-oss:
    needs: analyze-security  # â›”ï¸ åªæœ‰å½“æ‰«æé€šè¿‡ï¼Œæ‰ä¼šæ‰§è¡Œè¿™ä¸€æ­¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup OSS Tool
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: "${{ env.OSS_ENDPOINT }}"
          access-key-id: "${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
          access-key-secret: "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }} "

      - name: Upload Code
        run: |
          OSS_PATH="oss://${{ env.OSS_BUCKET }}/releases/${{ github.sha }}/"
          ossutil cp -r . "$OSS_PATH"
          echo "âœ… ä»£ç ä¸Šä¼ æˆåŠŸ"