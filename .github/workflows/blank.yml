name: Aliyun CI/CD Test

on:
  # 手动触发器：允许你在界面上选择跑哪条路
  workflow_dispatch:
    inputs:
      deploy_target:
        description: '选择部署目标 (ACR 或 OSS)'
        required: true
        default: 'ACR'
        type: choice
        options:
        - ACR
        - OSS

jobs:
  # === 任务 A: 构建并推送镜像 (ACR 路线) ===
  build-and-push-acr:
    if: inputs.deploy_target == 'ACR'
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码 (Checkout)
        uses: actions/checkout@v3

      - name: 2. 登录阿里云 ACR (Login)
        uses: aliyun/acr-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          password: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: 3. 构建并推送镜像 (Build & Push)
        run: |
          # 定义镜像标签 (使用时间戳作为版本号)
          IMAGE_TAG=${{ secrets.ACR_REGISTRY }}/test-namespace/my-app:${{ github.run_id }}
          
          # 构建
          docker build -t $IMAGE_TAG .
          
          # 推送
          docker push $IMAGE_TAG
          
          echo "镜像已推送: $IMAGE_TAG"

  # === 任务 B: 上传代码 (OSS 路线) ===
  upload-to-oss:
    if: inputs.deploy_target == 'OSS'
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取代码 (Checkout)
        uses: actions/checkout@v3

      - name: 2. 安装 ossutil 工具
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: ${{ secrets.OSS_ENDPOINT }}
          access-key-id: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: 3. 上传代码至 OSS (Upload)
        run: |
          # 定义 OSS 路径 (使用 run_id 作为版本目录)
          OSS_PATH=oss://${{ secrets.OSS_BUCKET }}/releases/${{ github.run_id }}/
          
          # 上传 main.py
          ossutil cp main.py $OSS_PATH
          
          echo "代码已上传至: $OSS_PATH"
