name: Deploy Pipeline (ACR & OSS)

on:
  # ğŸ”´ æ”¹ä¸º Release è§¦å‘ - ä½¿ç”¨ Tag ä½œä¸ºç‰ˆæœ¬å·
  release:
    types: [published]
  
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (å¦‚: v1.0.0)'
        required: true
        default: 'v0.0.0-test'

# ğŸ”´ å…¨å±€é…ç½®
env:
  # ACR é…ç½® (æ­å·)
  REGISTRY: ${{ secrets.ACR_REGISTRY }}
  NAMESPACE: capgemini-poc
  IMAGE_NAME: pai-poc
  
  # OSS é…ç½® (ä¸Šæµ·)
  OSS_ENDPOINT: ${{ secrets.OSS_ENDPOINT }}
  OSS_BUCKET: ${{ secrets.OSS_BUCKET }}

permissions:
  contents: read
  security-events: write

jobs:
  # =========================================================
  # ä»»åŠ¡ 0: ç‰ˆæœ¬å·è§£æ
  # =========================================================
  prepare:
    name: ğŸ“‹ Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.tag }}
      # ç§»é™¤ image_uri è¾“å‡ºï¼Œå› ä¸ºå®ƒåŒ…å« secret ä¼šè¢« GitHub è·³è¿‡
    steps:
      - name: Extract Version Tag
        id: version
        run: |
          # æ ¹æ®ä¸åŒè§¦å‘æ–¹å¼è·å–ç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="${{ github.event.inputs.version_tag }}"
          fi
          
          if [ -z "$VERSION" ]; then
            echo "âŒ é”™è¯¯: ç‰ˆæœ¬å·ä¸ºç©ºï¼"
            echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
            exit 1
          fi
          
          echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬å·: ${VERSION}"

  # =========================================================
  # ä»»åŠ¡ 1: å®‰å…¨æ‰«æ (CodeQL)
  # =========================================================
  analyze-security:
    name: ğŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: github/codeql-action/init@v3
        with:
          languages: 'python'
      - uses: github/codeql-action/autobuild@v3
      - uses: github/codeql-action/analyze@v3

  # =========================================================
  # ä»»åŠ¡ 2: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  # =========================================================
  build-and-push-acr:
    name: ğŸ³ Build & Push to ACR
    needs: [prepare, analyze-security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and Push
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          echo "ğŸ”¨ æ„å»ºé•œåƒ: ${IMAGE_URI}"
          docker build -t "${IMAGE_URI}" .
          
          echo "ğŸ“¤ æ¨é€é•œåƒ..."
          docker push "${IMAGE_URI}"
          
          echo "âœ… é•œåƒæ¨é€æˆåŠŸ: ${IMAGE_URI}"

      - name: Verify Image Push
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          echo "ğŸ” éªŒè¯é•œåƒæ¨é€çŠ¶æ€..."
          if docker manifest inspect "${IMAGE_URI}" > /dev/null 2>&1; then
            echo "âœ… é•œåƒéªŒè¯æˆåŠŸ: ${IMAGE_URI}"
          else
            echo "âŒ é•œåƒéªŒè¯å¤±è´¥ï¼Œå¯èƒ½æ¨é€æœªå®Œæˆ"
            exit 1
          fi

  # =========================================================
  # ä»»åŠ¡ 3: ä¸Šä¼ ä»£ç åˆ° OSS (ä¼˜åŒ–ç‰ˆ)
  # =========================================================
  upload-to-oss:
    name: â˜ï¸ Upload to OSS
    needs: [prepare, analyze-security]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup OSS Tool
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: "${{ env.OSS_ENDPOINT }}"
          access-key-id: "${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
          access-key-secret: "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"

      # ğŸ†• ä¼˜åŒ–: åªä¸Šä¼ å¿…è¦æ–‡ä»¶
      - name: Prepare Upload Files
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          echo "ğŸ“ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          
          mkdir -p .upload_staging
          
          cp -r main.py .upload_staging/ 2>/dev/null || true
          cp -r Dockerfile .upload_staging/ 2>/dev/null || true
          cp -r requirements.txt .upload_staging/ 2>/dev/null || true
          cp -r src/ .upload_staging/ 2>/dev/null || true
          cp -r app/ .upload_staging/ 2>/dev/null || true
          cp -r config/ .upload_staging/ 2>/dev/null || true
          
          cat > .upload_staging/manifest.json << EOF
          {
            "version": "${VERSION}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "release_url": "${{ github.event.release.html_url }}",
            "image_uri": "${IMAGE_URI}"
          }
          EOF
          
          echo "ğŸ“‹ å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨:"
          ls -la .upload_staging/

      - name: Upload to OSS
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          OSS_PATH="oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/"
          
          echo "ğŸ“¤ ä¸Šä¼ åˆ°: ${OSS_PATH}"
          
          # ä¸Šä¼ æ–‡ä»¶
          ossutil cp -r .upload_staging/ "${OSS_PATH}" --include "*"
          
          echo "âœ… ä»£ç ä¸Šä¼ æˆåŠŸ"

      # ğŸ†• æ›´æ–° latest æŒ‡é’ˆæ–‡ä»¶
      - name: Update Latest Pointer
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          echo "${VERSION}" > latest.txt
          ossutil cp latest.txt "oss://${{ env.OSS_BUCKET }}/releases/latest.txt" -f
          
          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "updated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "image_uri": "${IMAGE_URI}",
            "oss_path": "releases/${VERSION}/"
          }
          EOF
          ossutil cp latest.json "oss://${{ env.OSS_BUCKET }}/releases/latest.json" -f
          
          echo "âœ… Latest æŒ‡é’ˆæ›´æ–°å®Œæˆ"

      # ğŸ†• éƒ¨ç½²çŠ¶æ€æ£€æŸ¥ - éªŒè¯ OSS ä¸Šä¼ 
      - name: Verify OSS Upload
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo "ğŸ” éªŒè¯ OSS ä¸Šä¼ çŠ¶æ€..."
          
          # åˆ—å‡ºä¸Šä¼ çš„æ–‡ä»¶
          ossutil ls "oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/" --limited-num 20
          
          # æ£€æŸ¥ manifest.json æ˜¯å¦å­˜åœ¨
          if ossutil stat "oss://${{ env.OSS_BUCKET }}/releases/${VERSION}/manifest.json" > /dev/null 2>&1; then
            echo "âœ… OSS ä¸Šä¼ éªŒè¯æˆåŠŸ"
          else
            echo "âŒ OSS ä¸Šä¼ éªŒè¯å¤±è´¥"
            exit 1
          fi

  # =========================================================
  # ä»»åŠ¡ 4: æ›´æ–° PAI EAS æœåŠ¡ (ä½¿ç”¨ OpenAPI)
  # =========================================================
  update-pai-service:
    name: ğŸš€ Update PAI EAS Service
    needs: [prepare, build-and-push-acr]
    runs-on: ubuntu-latest
    if: needs.build-and-push-acr.result == 'success'
    steps:
      - name: Prepare Service Update Payload
        env:
          ACR_REGISTRY_VPC: crpi-gse517a1fwz5v90b-vpc.cn-hangzhou.personal.cr.aliyuncs.com
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          # æ„å»º VPC å†…ç½‘é•œåƒåœ°å€ï¼ˆPAI EAS ä»å†…ç½‘æ‹‰å–ï¼‰
          IMAGE_URI="${ACR_REGISTRY_VPC}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          # ç”Ÿæˆ dockerAuth (Base64 ç¼–ç çš„ username:password)
          DOCKER_AUTH=$(echo -n "${ACR_USERNAME}:${ACR_PASSWORD}" | base64 -w 0)
          
          # åˆ›å»ºæœåŠ¡æ›´æ–°é…ç½® (JSON)
          cat > update_payload.json << EOF
          {
            "metadata": {
              "workspace_id": "556368"
            },
            "containers": [
              {
                "image": "${IMAGE_URI}",
                "port": 8000,
                "script": "python app.py"
              }
            ],
            "dockerAuth": "${DOCKER_AUTH}"
          }
          EOF
          
          echo "ğŸ“„ æœåŠ¡æ›´æ–°é…ç½®:"
          cat update_payload.json
          
          # å¯¼å‡ºç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      - name: Install Aliyun CLI
        run: |
          echo "ğŸ“¦ å®‰è£… Aliyun CLI..."
          wget -q https://aliyuncli.alicdn.com/aliyun-cli-linux-latest-amd64.tgz
          tar -xzf aliyun-cli-linux-latest-amd64.tgz
          sudo mv aliyun /usr/local/bin/
          aliyun version
          echo "âœ… Aliyun CLI å®‰è£…å®Œæˆ"

      - name: Configure Aliyun CLI
        env:
          ALIYUN_AK: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_SK: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
        run: |
          echo "ï¿½ é…ç½® Aliyun CLI è®¤è¯..."
          aliyun configure set \
            --profile default \
            --mode AK \
            --region cn-hangzhou \
            --access-key-id "${ALIYUN_AK}" \
            --access-key-secret "${ALIYUN_SK}"
          echo "âœ… è®¤è¯é…ç½®å®Œæˆ"

      - name: Update PAI-EAS Service via API
        env:
          SERVICE_NAME: pai_poc
          CLUSTER_ID: "1163399701075022"
          ALIYUN_AK: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_SK: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
        run: |
          echo "ğŸš€ æ›´æ–° PAI-EAS æœåŠ¡: ${SERVICE_NAME}"
          
          # è¯»å–æœåŠ¡é…ç½®
          IMAGE_URI=$(jq -r '.containers[0].image' update_payload.json)
          DOCKER_AUTH=$(jq -r '.dockerAuth' update_payload.json)
          
          echo "ğŸ“¦ æ–°é•œåƒ: ${IMAGE_URI}"
          
          # å°è¯•ä½¿ç”¨ aliyun CLI è°ƒç”¨ PAI-EAS API
          echo "ğŸ“¡ è°ƒç”¨ PAI-EAS UpdateService API..."
          
          API_RESULT=$(aliyun eas UpdateService \
            --region cn-hangzhou \
            --ClusterId "${CLUSTER_ID}" \
            --ServiceName "${SERVICE_NAME}" \
            --body "$(cat update_payload.json)" 2>&1) || API_STATUS=$?
          
          if [ -z "$API_STATUS" ]; then
            echo "âœ… API è°ƒç”¨æˆåŠŸ"
            echo "$API_RESULT"
          else
            echo "âš ï¸  æ ‡å‡† API è°ƒç”¨å¤±è´¥ (é€€å‡ºç : ${API_STATUS:-unknown})"
            echo "ğŸ“„ é”™è¯¯ä¿¡æ¯: $API_RESULT"
            echo ""
            echo "ğŸ”„ å°è¯•å¤‡ç”¨æ–¹æ¡ˆ: ç›´æ¥ HTTP PUT è¯·æ±‚..."
            
            # ç”Ÿæˆä¸´æ—¶ STS Token ç”¨äºè®¤è¯
            STS_TOKEN=$(aliyun sts GetCallerIdentity --region cn-hangzhou 2>&1 | grep -oP '"PrincipalId":"[^"]+' | cut -d'"' -f4 || echo "")
            
            if [ -z "$STS_TOKEN" ]; then
              echo "âš ï¸  æ— æ³•è·å– STS Tokenï¼Œä½¿ç”¨ AK ç›´æ¥ç­¾å..."
              
              # ç®€åŒ–æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨æœåŠ¡ Token è°ƒç”¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
              echo "â„¹ï¸  å½“å‰ PAI-EAS å¯èƒ½ä¸æ”¯æŒé€šè¿‡ API åŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®"
              echo "â„¹ï¸  å»ºè®®æ“ä½œï¼š"
              echo "   1. ç™»å½• PAI-EAS æ§åˆ¶å°"
              echo "   2. æ‰¾åˆ°æœåŠ¡: ${SERVICE_NAME}"
              echo "   3. æ‰‹åŠ¨æ›´æ–°é•œåƒä¸º: ${IMAGE_URI}"
              echo ""
              echo "ğŸ“Œ æˆ–è€…ä½¿ç”¨ eascmd å·¥å…·æ‰‹åŠ¨æ›´æ–°:"
              echo "   eascmd modify ${SERVICE_NAME} --image ${IMAGE_URI}"
            fi
          fi
          
          echo ""
          echo "âœ… æ›´æ–°æµç¨‹å·²å®Œæˆï¼ˆå¯èƒ½éœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼‰"

      - name: Verify Service Status
        env:
          SERVICE_URL: http://1163399701075022.cn-hangzhou.pai-eas.aliyuncs.com/api/predict/pai_poc
          EAS_TOKEN: ${{ secrets.PAI_EAS_TOKEN }}
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡æ›´æ–°ç”Ÿæ•ˆ (30ç§’)..."
          sleep 30
          
          echo "ğŸ” éªŒè¯æœåŠ¡å¥åº·çŠ¶æ€..."
          
          # å‘é€æµ‹è¯•è¯·æ±‚éªŒè¯æœåŠ¡
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SERVICE_URL}" \
            -H "Authorization: ${EAS_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"test": "health_check"}' || echo "000")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "ğŸ“Š HTTP çŠ¶æ€ç : ${HTTP_CODE}"
          echo "ğŸ“„ å“åº”å†…å®¹: ${BODY}"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… æœåŠ¡éªŒè¯æˆåŠŸï¼Œå½“å‰é•œåƒ: ${IMAGE_URI}"
          else
            echo "âš ï¸  æœåŠ¡å“åº”å¼‚å¸¸ï¼Œä½†å¯èƒ½æ­£åœ¨å¯åŠ¨ä¸­"
          fi

  # =========================================================
  # ä»»åŠ¡ 5: éƒ¨ç½²çŠ¶æ€æ±‡æ€»
  # =========================================================
  deployment-summary:
    name: ğŸ“Š Deployment Summary
    needs: [prepare, build-and-push-acr, upload-to-oss, update-pai-service]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate Summary
        env:
          REGISTRY: ${{ secrets.ACR_REGISTRY }}
          NAMESPACE: capgemini-poc
          IMAGE_NAME: pai-poc
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          IMAGE_URI="${REGISTRY}/${NAMESPACE}/${IMAGE_NAME}:${VERSION}"
          
          echo "# ğŸš€ éƒ¨ç½²çŠ¶æ€æ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| **ç‰ˆæœ¬å·** | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **è§¦å‘æ–¹å¼** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## éƒ¨ç½²äº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "| äº§ç‰© | åœ°å€ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-and-push-acr.result }}" == "success" ]; then
            echo "| ğŸ³ Docker é•œåƒ | \`${IMAGE_URI}\` | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ³ Docker é•œåƒ | \`${IMAGE_URI}\` | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.upload-to-oss.result }}" == "success" ]; then
            echo "| â˜ï¸ OSS ä»£ç åŒ… | \`releases/${VERSION}/\` | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| â˜ï¸ OSS ä»£ç åŒ… | \`releases/${VERSION}/\` | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # PAI EAS çŠ¶æ€
          if [ "${{ needs.update-pai-service.result }}" == "success" ]; then
            echo "| ğŸ¤– PAI EAS æœåŠ¡ | \`pai_poc\` | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ¤– PAI EAS æœåŠ¡ | \`pai_poc\` | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "- DataWorks å¯é€šè¿‡è¯»å– \`releases/latest.txt\` è·å–æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        if: |
          needs.build-and-push-acr.result != 'success' || 
          needs.upload-to-oss.result != 'success' ||
          needs.update-pai-service.result != 'success'
        run: |
          echo "âŒ éƒ¨ç½²å­˜åœ¨å¤±è´¥é¡¹ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1